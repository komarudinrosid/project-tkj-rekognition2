<!-- /Users/arrosid/Dev/project-tkj-rekognition/templates/index.html -->
<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Capture & Rekognition</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
video, img { width: 100%; max-width: 480px; border-radius: 8px; background: #000; }
button { padding: 10px 14px; margin-right: 8px; margin-top: 8px; }
pre { background: #f5f5f7; padding: 12px; overflow: auto; border-radius: 8px; }
</style>
</head>
<body>
<h2>Ambil Foto, Upload ke S3, Cocokkan Rekognition</h2>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas" hidden></canvas>
<div>
<button id="startCamera" type="button">Aktifkan Kamera</button>
<button id="snap" type="button" disabled>Ambil Foto</button>
<button id="upload" type="button" disabled>Upload & Cocokkan</button>
</div>
<div id="camStatus"></div>
<p>Alternatif pilih file:</p>
<input id="fileInput" type="file" accept="image/*" capture="environment">
<img id="preview" alt="Preview">
<h3>Status</h3>
<div id="status"></div>
<h3>Analisa</h3>
<pre id="analysis"></pre>
<h3>Hasil (debug)</h3>
<pre id="result"></pre>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startCamera');
const snapBtn = document.getElementById('snap');
const uploadBtn = document.getElementById('upload');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const result = document.getElementById('result');
const status = document.getElementById('status');
const analysisEl = document.getElementById('analysis');
const camStatus = document.getElementById('camStatus');
let lastBlob = null;

function mapGender(v){if(v==='Male')return 'Laki-laki';if(v==='Female')return 'Perempuan';return '-';}
function mapEmotion(t){const m={HAPPY:'senang',SAD:'sedih',ANGRY:'marah',CONFUSED:'bingung',DISGUSTED:'jijik',CALM:'tenang',SURPRISED:'terkejut',FEAR:'takut',UNKNOWN:'tidak diketahui'};return m[t]||t||'-';}
function formatAnalysis(a){const g=mapGender(a.gender);const age=a.ageRange&&a.ageRange.low!=null&&a.ageRange.high!=null?`${a.ageRange.low}-${a.ageRange.high}`:'-';const emos=(a.emotions||[]).slice(0,3).map(e=>mapEmotion(e.type)).filter(Boolean);const emo=emos.length?emos.join(', '):(a.dominantEmotion?mapEmotion(a.dominantEmotion):'-');return `Kelamin: ${g}\nEkspresi: ${emo}\nPerkiraan umur: ${age}`;}

if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
  camStatus.textContent = 'Kamera butuh HTTPS. Gunakan domain dengan TLS atau tunnel (cloudflared/ngrok), atau pilih file manual.';
}

startBtn.onclick = async () => {
  camStatus.textContent = '';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
    video.srcObject = stream;
    await video.play().catch(() => {});
    snapBtn.disabled = false;
    camStatus.textContent = 'Kamera aktif';
  } catch (e) {
    snapBtn.disabled = true;
    const secureHint = (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1')
      ? ' (butuh HTTPS untuk akses kamera)'
      : '';
    camStatus.textContent = 'Gagal mengaktifkan kamera' + secureHint;
  }
};

snapBtn.onclick = () => {
  const w = video.videoWidth, h = video.videoHeight;
  if (!w || !h) return;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  canvas.toBlob(b => { lastBlob = b; preview.src = URL.createObjectURL(b); uploadBtn.disabled = false; }, 'image/jpeg', 0.9);
};

fileInput.onchange = () => {
  const f = fileInput.files[0];
  if (f) { lastBlob = f; preview.src = URL.createObjectURL(f); uploadBtn.disabled = false; }
};

uploadBtn.onclick = async () => {
  if (!lastBlob) return;
  const fd = new FormData();
  fd.append('photo', lastBlob, 'capture.jpg');
  const res = await fetch('/upload', { method: 'POST', body: fd });
  const json = await res.json();
  result.textContent = JSON.stringify(json, null, 2);
  if (json.recognized) {
    status.textContent = `Dikenali: ${json.name || '(tanpa nama)'} (similarity ${json.similarity ? json.similarity.toFixed(1) : 'n/a'}%)`;
    analysisEl.textContent = '';
  } else {
    status.textContent = json.message || 'kamu tidak dikenali';
    analysisEl.textContent = formatAnalysis(json.analysis || {});
  }
};
</script>
</body>
</html>